# NLWeb RAG API: Database Record Requirements

## 1. Overview

This document outlines the specific data structure and schema that the NLWeb RAG API expects for each record stored in the PostgreSQL database. To ensure seamless integration with the `sitetor.ai` platform, it is crucial that the data scraping and embedding pipeline populates the database according to these specifications.

The NLWeb core relies on this structured data to perform accurate, multi-tenant retrieval and to provide rich, context-aware responses through its various tools and LLM interactions. Adherence to this data contract is essential for the proper functioning of the API.

---

## 2. Database Schema Definition

The target table for storing all embedded content is named `vector_embeddings`. The `sitetor.ai` data ingestion service is responsible for populating this table.

The required schema is defined by the following SQL statement:

```sql
-- This table stores the vector embeddings for chunks of documents.
CREATE TABLE vector_embeddings (
    embedding_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID NOT NULL, -- In sitetor.ai, this will be a foreign key to the indexed_docs table
    site_id UUID NOT NULL,     -- In sitetor.ai, this will be a foreign key to the sites table
    id TEXT NOT NULL,          -- Original document ID from source (e.g., URL hash)
    url TEXT NOT NULL,
    name TEXT NOT NULL,
    schema_json JSONB NOT NULL,
    embedding vector(1536) NOT NULL,
    content TEXT               -- The raw text chunk that was embedded
);

-- A unique constraint prevents duplicate entries for the same document chunk within a site.
ALTER TABLE vector_embeddings ADD CONSTRAINT unique_doc_chunk_per_site UNIQUE (id, site_id);

-- A vector index for fast similarity searches.
CREATE INDEX IF NOT EXISTS embedding_cosine_idx
ON vector_embeddings USING hnsw (embedding vector_cosine_ops);
```

---

## 3. Field-by-Field Breakdown

Each column in the `vector_embeddings` table serves a specific purpose. The `sitetor.ai` ingestion pipeline is responsible for providing data for most of these fields.

| Column Name     | Data Type      | Nullable | Description                                                                                                                                                           | Responsibility      |
|-----------------|----------------|----------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------|
| `embedding_id`  | `UUID`         | No       | **Primary Key.** A unique identifier for the embedding record itself. This is typically generated by the database upon insertion (`DEFAULT gen_random_uuid()`).        | Database            |
| `document_id`   | `UUID`         | No       | **Foreign Key.** A UUID that links this embedding chunk back to a parent document in the `sitetor.ai` `indexed_docs` table. This is critical for data relationships.     | `sitetor.ai` Pipeline |
| `site_id`       | `UUID`         | No       | **Foreign Key & Tenant ID.** A UUID that links this record to a specific site in the `sitetor.ai` `sites` table. This ensures strict data partitioning and multi-tenancy. | `sitetor.ai` Pipeline |
| `id`            | `TEXT`         | No       | **Original Source ID.** The original, unique identifier for the document chunk from its source (e.g., a hash of the URL, a product SKU). Used to prevent duplicates.     | `sitetor.ai` Pipeline |
| `url`           | `TEXT`         | No       | The canonical URL pointing to the source of the content.                                                                                                              | `sitetor.ai` Pipeline |
| `name`          | `TEXT`         | No       | The title or name of the item (e.g., product name, article title).                                                                                                    | `sitetor.ai` Pipeline |
| `schema_json`   | `JSONB`        | No       | **Crucial for RAG.** The structured data for the item, ideally in **Schema.org** format. This JSON object is used by LLMs for ranking, summarization, and tool use.      | `sitetor.ai` Pipeline |
| `embedding`     | `vector(1536)` | No       | The vector embedding of the `content` field. The dimension (e.g., 1536) must match the embedding model used by the NLWeb API.                                         | `sitetor.ai` Pipeline |
| `content`       | `TEXT`         | Yes      | The raw text chunk that was processed by the embedding model to generate the `embedding`.                                                                             | `sitetor.ai` Pipeline |

---

## 4. Example Record

The `sitetor.ai` pipeline should generate data that can be structured into a format like the following example before being passed to the `postgres_client.upload_documents` method. This represents a single chunk of a document that has been scraped and processed.

```json
{
  "document_id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
  "site_id": "fedcba98-7654-3210-fedc-ba9876543210",
  "id": "product-12345-chunk-1",
  "url": "https://example.com/products/awesome-gadget",
  "name": "Awesome Gadget",
  "schema_json": {
    "@context": "https://schema.org/",
    "@type": "Product",
    "name": "Awesome Gadget",
    "image": "https://example.com/images/gadget.jpg",
    "description": "The Awesome Gadget is a revolutionary device that will change your life. It's packed with features and has a sleek, modern design.",
    "brand": {
      "@type": "Brand",
      "name": "GadgetCorp"
    },
    "sku": "12345",
    "offers": {
      "@type": "Offer",
      "url": "https://example.com/products/awesome-gadget",
      "priceCurrency": "USD",
      "price": "99.99",
      "availability": "https://schema.org/InStock"
    }
  },
  "embedding": [0.012, -0.034, 0.056, ..., -0.078],
  "content": "The Awesome Gadget is a revolutionary device that will change your life. It's packed with features and has a sleek, modern design."
}
```

---

## 5. Key Requirements Checklist for `sitetor.ai`

- [ ] **Multi-Tenancy is Mandatory:** Every record **must** have a valid `site_id` that corresponds to an entry in the `sites` table.
- [ ] **Link Back to Source Document:** Every record **must** have a `document_id` linking it to the main document entry in the `indexed_docs` table.
- [ ] **Provide Structured Data:** The `schema_json` field is not optional. It is fundamental to the quality of the RAG output. Use `Schema.org` vocabulary whenever possible.
- [ ] **Match Embedding Dimensions:** The vector dimension of the `embedding` must be consistent with the embedding model configured in the NLWeb API (e.g., 1536 for OpenAI `text-embedding-3-small`).
- [ ] **Ensure Chunk Uniqueness:** The combination of `id` (source ID) and `site_id` must be unique to prevent data duplication and update conflicts.
